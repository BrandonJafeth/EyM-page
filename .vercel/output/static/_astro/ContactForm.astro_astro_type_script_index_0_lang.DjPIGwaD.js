const f={},b={};function I(){const m=document.getElementById("provincia"),c=document.getElementById("canton"),a=document.getElementById("distrito"),p=document.getElementById("canton-wrapper"),d=document.getElementById("distrito-wrapper"),l=document.getElementById("contact-form"),g=document.getElementById("form_start_time");if(g&&(g.value=Date.now().toString()),!m||!c||!a||!p||!d||!l)return;const u=(n,t)=>{const o=document.getElementById(n),e=document.getElementById(`error-${n}`);o&&(o.classList.add("border-red-300","bg-red-50"),o.classList.remove("border-gray-200","bg-gray-50")),e&&(e.textContent=t,e.classList.remove("hidden"),e.classList.add("animate-in","fade-in","slide-in-from-top-1"))},E=()=>{["nombre","email","telefono"].forEach(t=>{const o=document.getElementById(t),e=document.getElementById(`error-${t}`);o&&(o.classList.remove("border-red-300","bg-red-50"),o.classList.add("border-gray-200","bg-gray-50")),e&&(e.classList.add("hidden"),e.textContent="")});const n=document.getElementById("form-status");n&&n.classList.add("hidden")},h=(n,t)=>{const o=document.getElementById("form-status");if(o){if(o.classList.remove("hidden","bg-green-50","border-green-200","text-green-800","bg-red-50","border-red-200","text-red-800"),t==="success"){const e=document.getElementById("nombre"),r=e?e.value.split(" ")[0]:"visitante";o.classList.add("bg-green-50","border-green-200","text-green-800"),o.innerHTML=`
                    <div class="flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="font-bold text-sm md:text-base">Gracias ${r}, hemos recibido tu mensaje. Te contactaremos pronto.</span>
                    </div>
                `,l.reset(),g&&(g.value=Date.now().toString())}else o.classList.add("bg-red-50","border-red-200","text-red-800"),o.innerHTML=`
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
                        <span class="font-bold">Error:</span> <span class="text-sm">${n}</span>
                    </div>
                `;t!=="success"&&o.scrollIntoView({behavior:"smooth",block:"center"})}},w=n=>{let t=!0;E();const o=n.get("nombre"),e=n.get("email"),r=n.get("telefono");return o.length<2&&(u("nombre","El nombre es muy corto."),t=!1),/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)||(u("email","El correo electrónico no es válido."),t=!1),r.replace(/\D/g,"").length<8&&(u("telefono","El teléfono debe tener al menos 8 dígitos."),t=!1),t};l.addEventListener("submit",async n=>{n.preventDefault();const t=l.querySelector('button[type="submit"]'),o=t.innerText,e=new FormData(l);if(w(e)){t.disabled=!0,t.innerText="Enviando...";try{const s=Object.fromEntries(e.entries()),i=await fetch("/api/send-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});let v;const y=i.headers.get("content-type");if(y&&y.indexOf("application/json")!==-1)v=await i.json();else{const B=await i.text();throw console.error("Server returned non-JSON:",B),new Error("El servidor no respondió correctamente.")}if(!i.ok)throw new Error(v.message||"Error al enviar el formulario");h("Success","success")}catch(s){console.error("Error submitting form:",s),h(s.message||"Hubo un problema al enviar. Intenta de nuevo.","error")}finally{t.disabled=!1,t.innerText=o}}});async function x(n){if(!(!n||!c||!a||!d||!p)){c.innerHTML='<option value="" disabled selected>Seleccionar Cantón...</option>',a.innerHTML='<option value="" disabled selected>Seleccionar Distrito...</option>',c.disabled=!0,a.disabled=!0,d.classList.add("hidden");try{let t;f[n]?t=f[n]:(t=await(await fetch(`https://ubicaciones.paginasweb.cr/provincia/${n}/cantones.json`)).json(),f[n]=t),Object.entries(t).map(([e,r])=>({id:e,name:r})).forEach(e=>{const r=document.createElement("option");r.value=e.name,r.dataset.id=e.id,r.textContent=e.name,c.appendChild(r)}),c.disabled=!1,p.classList.remove("hidden"),p.classList.add("animate-in","fade-in","slide-in-from-top-2")}catch(t){console.error("Error fetching cantons:",t)}}}async function L(n,t){if(!n||!t||!a||!d)return;a.innerHTML='<option value="" disabled selected>Seleccionar Distrito...</option>',a.disabled=!0;const o=`${n}-${t}`;try{let e;b[o]?e=b[o]:(e=await(await fetch(`https://ubicaciones.paginasweb.cr/provincia/${n}/canton/${t}/distritos.json`)).json(),b[o]=e),Object.entries(e).map(([s,i])=>({id:s,name:i})).forEach(s=>{const i=document.createElement("option");i.value=s.name,i.dataset.id=s.id,i.textContent=s.name,a.appendChild(i)}),a.disabled=!1,d.classList.remove("hidden"),d.classList.add("animate-in","fade-in","slide-in-from-top-2")}catch(e){console.error("Error fetching districts:",e)}}m.addEventListener("change",n=>{const t=n.target,e=t.options[t.selectedIndex].dataset.id;e&&x(e)}),c.addEventListener("change",n=>{const t=n.target,e=t.options[t.selectedIndex].dataset.id,s=m.options[m.selectedIndex].dataset.id;s&&e&&L(s,e)})}document.addEventListener("astro:page-load",I);
